@using Data.DTO
@model Data.DTO.Cart.CartDTO

<!-- Single Page Header start -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Giỏ hàng</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="~/Home/Index">Trang chủ</a></li>
        <li class="breadcrumb-item active text-white">Giỏ hàng</li>
    </ol>
</div>
<!-- Single Page Header End -->
<!-- Cart Page Start -->
<div class="container-fluid py-5">
    <div class="container py-5">

        @if (!Model.Items.Any())
        {
            <div class="alert alert-info">
                Giỏ hàng của bạn đang trống
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Màu sắc / Size</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                            <th>Tổng tiền</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <td>
                                    <p class="mb-0 py-4">@item.ProductName</p>
                                </td>

                                <td>
                                    <p class="mb-0 py-4">
                                        @item.ColorName - @item.SizeName
                                    </p>
                                </td>

                                <td>
                                    <p class="mb-0 py-4">
                                        @item.Price.ToString("N0") ₫
                                    </p>
                                </td>

                                <td>
                                    <div class="input-group quantity py-4" style="width: 120px;">
                                        <button class="btn btn-sm rounded-circle bg-light border"
                                                onclick="changeQty(@item.ProductId, @item.ColorId, @item.SizeId, -1)">
                                            <i class="fa fa-minus"></i>
                                        </button>

                                        <input type="text"
                                               class="form-control form-control-sm text-center border-0 qty-input"
                                               data-key="@($"{item.ProductId}-{item.ColorId}-{item.SizeId}")"
                                               value="@item.Quantity" />

                                        <button class="btn btn-sm rounded-circle bg-light border"
                                                onclick="changeQty(@item.ProductId, @item.ColorId, @item.SizeId, 1)">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </td>

                                <td>
                                    <p class="mb-0 py-4 line-total"
                                       data-key="@($"{item.ProductId}-{item.ColorId}-{item.SizeId}")"
                                       data-price="@item.Price">
                                        @((item.Price * item.Quantity).ToString("N0")) ₫
                                    </p>
                                </td>

                                <!-- REMOVE -->
                                <td class="py-4">
                                    <button class="btn btn-md rounded-circle bg-light border btn-remove"
                                            data-productid="@item.ProductId"
                                            data-colorid="@item.ColorId"
                                            data-sizeid="@item.SizeId">
                                        <i class="fa fa-times text-danger"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- CART TOTAL -->
            <div class="row g-4 justify-content-end">
                <div class="col-sm-8 col-md-7 col-lg-6 col-xl-4">
                    <div class="bg-light rounded">
                        <div class="p-4">
                            <h4 class="mb-4">Tổng đơn hàng</h4>

                            <div class="d-flex justify-content-between mb-3">
                                <span>Tạm tính</span>
                                <span id="subTotal">@Model.SubTotal.ToString("N0") ₫</span>
                            </div>
                        </div>

                        <div class="py-3 border-top d-flex justify-content-between px-4">
                            <strong>Tổng cộng</strong>
                            <strong id="cartTotal">@Model.Total.ToString("N0") ₫</strong>
                        </div>

                        <div class="p-4">
                            <a href="/Checkout"
                               class="btn btn-primary rounded-pill w-100 py-3">
                                Tiến hành thanh toán
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
<!-- Cart Page End -->
<script>
    function changeQty(productId, colorId, sizeId, delta) {

        const key = `${productId}-${colorId}-${sizeId}`;
        const input = document.querySelector(`.qty-input[data-key="${key}"]`);
        if (!input) return;

        if (input.dataset.loading === "1") return;
        input.dataset.loading = "1";

        const currentQty = parseInt(input.value) || 1;
        const newQty = currentQty + delta;

        fetch('/Cart/Update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body:
                `productId=${productId}` +
                `&colorId=${colorId}` +
                `&sizeId=${sizeId}` +
                `&quantity=${newQty}`
        })
        .then(res => {
            if (!res.ok) throw new Error("Update failed");
            return res.json();
        })
        .then(() => {
            reloadCartView();
        })
        .catch(err => {
            console.error(err);
            alert("Có lỗi khi cập nhật số lượng");
        })
        .finally(() => {
            input.dataset.loading = "0";
        });
    }

    document.addEventListener('click', function (e) {

        const btn = e.target.closest('.btn-remove');
        if (!btn) return;

        if (!confirm("Xoá sản phẩm khỏi giỏ hàng?")) return;

        fetch('/Cart/Remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body:
                `productId=${btn.dataset.productid}` +
                `&colorId=${btn.dataset.colorid}` +
                `&sizeId=${btn.dataset.sizeid}`
        })
        .then(res => {
            if (!res.ok) throw new Error("Remove failed");
            reloadCartView();
        })
        .catch(err => {
            console.error(err);
            alert("Có lỗi khi xoá sản phẩm");
        });
    });

    function reloadCartView() {
        fetch('/Cart')
            .then(res => res.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const newCart = doc.querySelector('.container.py-5');
                const currentCart = document.querySelector('.container.py-5');

                if (newCart && currentCart) {
                    currentCart.innerHTML = newCart.innerHTML;
                }
            });
    }
</script>



